<html>
<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-167439288-1"></script>
	<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());

	gtag('config', 'UA-167439288-1');
	</script>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"/>
	<meta charset="UTF-8">
	<link rel="shortcut icon" type="image/x-icon" href="icons/favicon.ico"/>
	<title>Six Triangles</title>
	<style>
		body {
			font-family: Arial;
		  }
	</style>
</head>
<body style="background-color:#2b2d30">
</body>
<script src="d3.min.js"></script>
<script>
	formSubmitting = false;
	window.onload = function() {
		window.addEventListener("beforeunload", function (e) {
			if (formSubmitting) {
				return undefined;
			}
			var confirmationMessage = 'Your results were not saved. Are you sure you wish to leave?';
			(e || window.event).returnValue = confirmationMessage; //Gecko + IE
			return confirmationMessage; //Gecko + Webkit, Safari, Chrome etc.
		});
	};
	function shuffle(array) {
		var currentIndex = array.length, temporaryValue, randomIndex;
		
		// While there remain elements to shuffle...
		while (0 !== currentIndex) {
		
			// Pick a remaining element...
			randomIndex = Math.floor(Math.random() * currentIndex);
			currentIndex -= 1;
		
			// And swap it with the current element.
			temporaryValue = array[currentIndex];
			array[currentIndex] = array[randomIndex];
			array[randomIndex] = temporaryValue;
		}
		
		return array;
	}
	d3.csv("languages.csv?v=2").then(languages=>
	{
	d3.csv("questions.csv?v=2").then(questions=>
	{
		questionbank = [];
		toanswer = []
		results = []
		length = location.search.replace("?","").split("lang=")[1].split("&length=")[1]*1
		for(i = 0; i < 6; i++)
		{
			results[i] = []
			questionbank[i] = [];
			for(j = 0; j < 3; j++)
			{
				results[i][j] = 1;
				questionbank[i][j] = []
				for(k = 0; k < 4; k++)
				{
					questionbank[i][j][k] = [];
					for(q = 0; q < length; q++)
						toanswer.push([i,j,k])
				}
			}
		}
		for(i = 0; i < questions.length; i++)
		{
			questionbank[1*questions[i].Category][1*questions[i].Subcategory][(questions[i].Multiplier=="1"?(1*questions[i].Strength):(5-questions[i].Strength))-1].push(questions[i]);
		}
		questionlist = []
		for(i = 0; i < toanswer.length; i++)
		{
			array = questionbank[toanswer[i][0]][toanswer[i][1]][toanswer[i][2]]
			rn = Math.floor(Math.random() * array.length)
			questionlist[i] = array[rn];
			array.splice(rn, 1)
		}
		questionlist = shuffle(questionlist)
		encoding = "qwertyuiopasdfghjklzxcvbnmEBAFCD"
		lang = location.search.replace("?","").split("lang=")[1].split("&length=")[0];
		width = window.innerWidth-150;
		height = window.innerHeight-100;
		padding = 25;
		radius = 10;
		text = [languages[7][lang], languages[8][lang],languages[9][lang],languages[10][lang],languages[11][lang]]
		center = d3.select('body').append('center')
		questionlabel = center.append('h2').attr('x',width/2).attr('y',height*(0.5)/7 - padding/2).style("dominant-baseline","middle").style("text-anchor","middle").style('font-size',30).style('color','lightgrey');
		svg = center.append('svg').attr('width',width).attr('height',height);
		scale = ['#d7191c','#fdae61','#ffffbf','#a6d96a','#1a9641'];
		function action(index)
		{
			questionlist[INDEX].answer = index;
			INDEX++;
			if(INDEX == questionlist.length)
			{
				formSubmitting = true;
				result = []
				for(i = 0; i < 6; i++)
				{
					result[i] = []
					for(j = 0; j < 3; j++)
						result[i][j] = 0;
				}
				for(i = 0; i < questionlist.length; i++)
				{
					result[1*questionlist[i].Category][1*questionlist[i].Subcategory]+=(questionlist[i].Multiplier=="1"?(4-questionlist[i].answer):(1*questionlist[i].answer));
				}
				for(i = 0; i < result.length; i++)
					for(j = 0; j < result[i].length; j++)
						result[i][j] = Math.max(0,result[i][j]-2*length)
				RES = ""
				for(i = 0; i < 6; i++)
				{
					total = d3.sum(result[i])
					if(total == 0)
					{
						result[i] = [1,1,1];
						total = 3;
					}
					for(j = 0; j < 2; j++)
					{
						amount = Math.round(1000*result[i][j]/total)
						RES += encoding[Math.floor(amount / 32)]
						RES += encoding[amount % 32]
					}
				}
				document.location.href = document.location.href.split("&length=")[0].replace("quiz.html?","results.html?"+RES+"&");
				return;
			}
			questionlabel.text("Question "+(INDEX+1)+" of "+questionlist.length+": "+questionlist[INDEX][lang])
			prevlabel.attr('width',width);
			prevtext.text(languages[12][lang])
		}
		for(i = 0; i < 5; i++)
		{
			svg.append('rect').attr('width',width).attr('height',height/7 - padding).attr('x',0).attr('y',height*(i+1)/7).attr('fill',scale[4-i]).attr('rx',radius).attr('ry',radius).attr('index',i).on('click',function(){action(d3.select(this).attr('index'))});
			svg.append('text').attr('x',width/2).attr('y',height*(i+1.5)/7 - padding/2).text(text[i]).style("dominant-baseline","middle").style("text-anchor","middle").style('font-size',30).attr('index',i).on('click',function(){action(d3.select(this).attr('index'))});
		}
		prevlabel = svg.append('rect').attr('width',0).attr('height',height/7 - padding).attr('x',0).attr('y',height*6/7).attr('fill',"grey").attr('rx',radius).attr('ry',radius).attr('index',i).on('click',function(){INDEX--;questionlabel.text("Question "+(INDEX+1)+" of "+questionlist.length+": "+questionlist[INDEX][lang]);if(INDEX == 0){prevlabel.attr('width',0); prevtext.text('');}});
		prevtext = svg.append('text').attr('x',width/2).attr('y',height*(5+1.5)/7 - padding/2).text("").style("dominant-baseline","middle").style("text-anchor","middle").style('font-size',30).attr('index',i).on('click',function(){INDEX--;questionlabel.text("Question "+(INDEX+1)+" of "+questionlist.length+": "+questionlist[INDEX][lang]);if(INDEX == 0){prevlabel.attr('width',0); prevtext.text('');}});
		INDEX = 0;
		questionlabel.text("Question "+(INDEX+1)+" of "+questionlist.length+": "+questionlist[INDEX][lang])
		
		
	});});
</script>
</html>
